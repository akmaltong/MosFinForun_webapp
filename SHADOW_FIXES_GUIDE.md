# Исправление артефактов теней

## Проблемы и решения

### Проблема 1: Shadow Acne (угловые артефакты)

**Симптомы:**
- Странные полосы/узоры на освещенных поверхностях
- "Угловатые" артефакты на плоских поверхностях
- Мерцание теней при движении камеры

**Причина:**
Слишком маленькие значения `shadow-bias` и `shadow-normalBias`

**Решение:**
```typescript
// Было:
shadow-bias={-0.0001}
shadow-normalBias={0.02}

// Стало:
shadow-bias={-0.001}      // Увеличено в 10 раз
shadow-normalBias={0.05}  // Увеличено в 2.5 раза
```

### Проблема 2: Light Bleeding (просачивание света)

**Симптомы:**
- Светлые полосы на стыках стен и пола
- Свет "просачивается" через геометрию
- Нереалистичное освещение в углах

**Причина:**
1. Слишком высокое ambient/hemisphere освещение
2. Отсутствие contact shadows

**Решение 1: Уменьшить ambient освещение**
```typescript
// Было:
<hemisphereLight
  intensity={1.5}
  groundColor="#444444"
/>

// Стало:
<ambientLight intensity={0.3} />
<hemisphereLight
  intensity={1.0}
  groundColor="#666666"  // Светлее для компенсации
/>
```

**Решение 2: Добавить Contact Shadows**
```typescript
<ContactShadows
  position={[0, -0.01, 0]}
  opacity={0.35}
  scale={200}
  blur={2.5}
  far={10}
  resolution={512}
  color="#000000"
/>
```

## Что исправлено

### Все схемы освещения

Обновлены параметры теней во всех файлах:

#### 1. Custom Lighting (Базовое)
**Файл:** `src/components/LightingSystem.tsx`

```typescript
// Directional Light
shadow-bias={-0.001}
shadow-normalBias={0.05}
shadow-mapSize={[2048, 2048]}
shadow-radius={3}

// Ambient + Hemisphere
<ambientLight intensity={0.3} />
<hemisphereLight intensity={1.0} groundColor="#666666" />
```

#### 2. Studio Lighting
**Файл:** `src/components/StudioLighting.tsx`

```typescript
// Key Light
shadow-bias={-0.001}
shadow-normalBias={0.05}
shadow-mapSize={[2048, 2048]}
shadow-radius={3}
```

#### 3. Architectural Lighting
**Файл:** `src/components/ArchitecturalLighting.tsx`

```typescript
// Sun Light
shadow-bias={-0.001}
shadow-normalBias={0.05}
shadow-mapSize={[2048, 2048]}  // Уменьшено с 4096 для производительности
shadow-radius={2}
```

#### 4. Exhibition Lighting
**Файл:** `src/components/ExhibitionLighting.tsx`

```typescript
// Main Light
shadow-bias={-0.001}
shadow-normalBias={0.05}
shadow-mapSize={[2048, 2048]}
shadow-radius={4}
```

### Новый компонент: GroundContactShadows

**Файл:** `src/components/GroundContactShadows.tsx`

Добавляет мягкие тени в местах контакта объектов с поверхностью.

**Особенности:**
- Адаптивные настройки для каждой схемы освещения
- Устраняет просачивание света на стыках
- Добавляет реализм в углах и на стыках

**Настройки по схемам:**

| Схема | Opacity | Blur | Описание |
|-------|---------|------|----------|
| Studio | 0.4 | 2.5 | Средняя интенсивность |
| Architectural | 0.5 | 2.0 | Более четкие тени |
| Exhibition | 0.2 | 3.0 | Очень мягкие тени |
| Custom | 0.35 | 2.5 | Сбалансированные |

## Технические детали

### Shadow Bias

**Что это:**
Смещение теневой карты для предотвращения self-shadowing (самозатенения).

**Как работает:**
- Отрицательное значение отодвигает тень от поверхности
- Слишком маленькое → shadow acne
- Слишком большое → "отрыв" тени от объекта (peter panning)

**Оптимальные значения:**
- `-0.001` до `-0.002` для большинства сцен
- `-0.0005` для очень детализированной геометрии
- `-0.005` для грубой геометрии

### Shadow Normal Bias

**Что это:**
Смещение вдоль нормали поверхности.

**Как работает:**
- Учитывает угол поверхности относительно света
- Предотвращает артефакты на наклонных поверхностях
- Более "умный" чем обычный bias

**Оптимальные значения:**
- `0.05` для большинства сцен
- `0.02` для очень гладких поверхностей
- `0.1` для сложной геометрии

### Shadow Map Size

**Что это:**
Разрешение текстуры теней.

**Влияние:**
- Больше → четче тени, но медленнее
- Меньше → размытые тени, но быстрее

**Рекомендации:**
- `1024x1024` - минимум для приемлемого качества
- `2048x2048` - оптимальный баланс (используем)
- `4096x4096` - максимальное качество (только для мощных GPU)

### Shadow Radius

**Что это:**
Степень размытия теней (только для PCFSoftShadowMap).

**Влияние:**
- `0` - резкие тени
- `2-3` - мягкие естественные тени
- `5+` - очень мягкие тени

**Рекомендации:**
- `2` - для architectural (реалистичные тени)
- `3` - для studio и custom (сбалансированные)
- `4` - для exhibition (очень мягкие)

### Contact Shadows

**Что это:**
Дополнительные тени в местах контакта объектов с поверхностью.

**Преимущества:**
- Устраняет light bleeding
- Добавляет "заземление" объектов
- Улучшает восприятие глубины

**Недостатки:**
- Дополнительная нагрузка на GPU
- Работает только на плоских поверхностях

**Оптимизация:**
```typescript
resolution={512}  // Достаточно для большинства сцен
blur={2.5}        // Баланс между качеством и производительностью
far={10}          // Ограничивает дальность расчета
```

## Проверка результатов

### Чеклист

- [ ] Нет угловых артефактов на плоских поверхностях
- [ ] Нет просачивания света на стыках стен/пола
- [ ] Тени выглядят естественно
- [ ] Нет "отрыва" теней от объектов (peter panning)
- [ ] Производительность приемлемая (60 FPS)

### Если проблемы остались

#### Артефакты все еще видны

Увеличьте bias:
```typescript
shadow-bias={-0.002}      // Было -0.001
shadow-normalBias={0.1}   // Было 0.05
```

#### Тени "отрываются" от объектов

Уменьшите bias:
```typescript
shadow-bias={-0.0005}     // Было -0.001
shadow-normalBias={0.02}  // Было 0.05
```

#### Просачивание света все еще есть

Увеличьте opacity contact shadows:
```typescript
<ContactShadows
  opacity={0.5}  // Было 0.35
  blur={2.0}     // Было 2.5 (более четкие)
/>
```

Или уменьшите ambient:
```typescript
<ambientLight intensity={0.2} />  // Было 0.3
```

#### Низкий FPS

Уменьшите разрешение теней:
```typescript
shadow-mapSize={[1024, 1024]}  // Было 2048
```

Или уменьшите resolution contact shadows:
```typescript
<ContactShadows resolution={256} />  // Было 512
```

## Дополнительные улучшения

### Для еще лучшего качества

#### 1. Variance Shadow Maps (VSM)

```typescript
// В Scene3D.tsx, onCreated
state.gl.shadowMap.type = THREE.VSMShadowMap
```

**Преимущества:**
- Более мягкие тени
- Меньше артефактов

**Недостатки:**
- Может быть light bleeding
- Требует больше памяти

#### 2. Cascaded Shadow Maps

Для больших сцен с динамическим солнцем.

**Требует:**
- Кастомная реализация
- Несколько shadow maps с разным разрешением

#### 3. PCSS (Percentage-Closer Soft Shadows)

Для реалистичных мягких теней.

**Требует:**
- Кастомный shader
- Больше производительности

## Итоги

### Что сделано:

✅ Исправлены shadow acne во всех схемах освещения
✅ Устранено просачивание света (light bleeding)
✅ Добавлены contact shadows для реализма
✅ Оптимизированы параметры теней
✅ Улучшена производительность (2048 вместо 4096)

### Результат:

- Чистые тени без артефактов
- Реалистичное освещение на стыках
- Хорошая производительность
- Единообразные настройки во всех схемах

---

*Документ создан: 2026-02-13*
*Версия: 1.0*
